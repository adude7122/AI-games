<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Music Player Pro - Fixed Scrolling</title>
  <style>
    /* V1 Global Styles */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      background: #f3f4f6;
      color: #111;
      transition: background 0.3s;
    }

    .container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 100%;
    }

    h1 { text-align: center; color: #333; margin-bottom: 25px; font-size: 28px; }

    /* V2 Control Section */
    .upload-section {
      margin-bottom: 25px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .playlist-row { display: flex; gap: 10px; }

    select {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: white;
      font-size: 14px;
    }

    .action-btn {
      padding: 10px 15px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    .file-input-label {
      display: block;
      padding: 12px 20px;
      background: #667eea;
      color: white;
      text-align: center;
      border-radius: 8px;
      cursor: pointer;
    }

    #fileInput { display: none; }

    /* Player Section */
    .player-section { margin-bottom: 25px; text-align: center; }
    .album-art-large {
      width: 220px;
      height: 220px;
      border-radius: 15px;
      object-fit: cover;
      margin: 0 auto 20px;
      display: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      border: 4px solid white;
    }

    .song-title { font-size: 20px; font-weight: bold; color: #333; margin-bottom: 5px; }
    
    .song-time {
      font-size: 14px;
      color: #666;
      margin-bottom: 15px;
    }

    .progress-container {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      margin: 10px 0 20px;
      cursor: pointer;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      border-radius: 4px;
      width: 0%;
    }

    .controls { display: flex; justify-content: center; align-items: center; gap: 15px; }
    .control-btn {
      width: 50px; height: 50px; border-radius: 50%; border: none;
      background: #667eea; color: white; font-size: 20px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }

    .control-btn.play-pause {
      width: 60px; height: 60px;
      background: linear-gradient(135deg, #667eea, #764ba2);
    }

    /* FIX: SCROLLABLE PLAYLIST SECTION */
    .playlist-section { 
      max-height: 250px; /* Limits height so more than 2 songs will scroll */
      overflow-y: auto;  /* Adds the scrollbar when needed */
      border-top: 2px solid #e0e0e0; 
      padding-top: 15px;
      padding-right: 5px; /* Space for scrollbar */
    }

    /* Custom Scrollbar Styling (V1 Style) */
    .playlist-section::-webkit-scrollbar { width: 6px; }
    .playlist-section::-webkit-scrollbar-track { background: transparent; }
    .playlist-section::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }

    .song-item {
      padding: 12px; 
      background: #f8f9fa; 
      margin-bottom: 8px; 
      border-radius: 8px;
      cursor: pointer; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      transition: background 0.2s;
    }
    .song-item:last-child { margin-bottom: 0; }
    .song-item.active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
    .delete-btn { padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; }

    @media (prefers-color-scheme: dark) {
      body { background: #0f1115; color: #e5e7eb; }
      .container { background: #1a1d24; }
      h1, .song-title { color: #ffffff; }
      .song-time { color: #a1a1aa; }
      .upload-section, .song-item { background: #232733; }
      select { background: #1e1e30; color: white; border-color: #444; }
      .progress-container { background: #2b2f3a; }
      .playlist-section::-webkit-scrollbar-thumb { background: #444; }
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>üéµ Cloud Music Player</h1>
    
    <div class="upload-section">
      <div class="playlist-row">
        <select id="playlistSelect"></select>
        <button class="action-btn" id="newPlaylist">+ New</button>
      </div>
      <label for="fileInput" class="file-input-label">üìÅ Upload to Playlist</label>
      <input type="file" id="fileInput" accept="audio/*" multiple>
    </div>

    <div class="player-section">
      <img id="albumArt" class="album-art-large">
      <div class="song-title" id="songTitle">No song selected</div>
      <div class="song-time">
        <span id="currentTime">0:00</span> / <span id="duration">0:00</span>
      </div>
      
      <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div class="controls">
        <button class="control-btn" id="prevBtn">‚èÆ</button>
        <button class="control-btn play-pause" id="playPauseBtn">‚ñ∂</button>
        <button class="control-btn" id="nextBtn">‚è≠</button>
      </div>
    </div>

    <div class="playlist-section" id="playlistContainer"></div>
    <audio id="audio"></audio>
  </div>

<script>
    let db, currentPlaylistId = null;
    let playlist = [], currentIndex = -1;

    const audio = document.getElementById('audio');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const songTitle = document.getElementById('songTitle');
    const currentTimeEl = document.getElementById('currentTime');
    const durationEl = document.getElementById('duration');
    const progressBar = document.getElementById('progressBar');
    const albumArt = document.getElementById('albumArt');
    const playlistContainer = document.getElementById('playlistContainer');
    const playlistSelect = document.getElementById('playlistSelect');

    async function initDB() {
      return new Promise((resolve) => {
        const req = indexedDB.open("MusicPlayerV2", 1);
        req.onupgradeneeded = e => {
          const db = e.target.result;
          db.createObjectStore("songs", { keyPath: "id", autoIncrement: true }).createIndex("playlistId", "playlistId");
          db.createObjectStore("playlists", { keyPath: "id", autoIncrement: true });
        };
        req.onsuccess = e => { db = e.target.result; resolve(); };
      });
    }

    function getStore(name, mode) { return db.transaction(name, mode).objectStore(name); }

    function formatTime(seconds) {
      if (isNaN(seconds)) return '0:00';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    async function fetchCloudArt(filename) {
      const query = filename.replace(/\.[^/.]+$/, "").replace(/[-_]/g, ' ');
      try {
        const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&media=music&limit=1`);
        const data = await res.json();
        if (data.results.length) return data.results[0].artworkUrl100.replace("100x100", "600x600");
      } catch(e) {}
      
      try {
        const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(`https://api.deezer.com/search?q=${query}&limit=1`)}`);
        const data = await res.json();
        const parsed = JSON.parse(data.contents);
        if (parsed.data.length) return parsed.data[0].album.cover_xl;
      } catch(e) {}
      return null;
    }

    async function playSong(i) {
      if (i < 0 || i >= playlist.length) return;
      currentIndex = i;
      const s = playlist[i];
      audio.src = URL.createObjectURL(new Blob([s.data], {type: s.type}));
      audio.play();
      songTitle.textContent = s.name;
      
      const art = await fetchCloudArt(s.name);
      albumArt.src = art || "";
      albumArt.style.display = art ? "block" : "none";
      
      renderPlaylist();
      
      // FIX: Auto-scroll to current song
      setTimeout(() => {
        const activeItem = document.querySelector('.song-item.active');
        if (activeItem) {
          activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      }, 100);
    }

    async function loadSongs() {
      const idx = getStore("songs", "readonly").index("playlistId");
      playlist = await new Promise(res => { idx.getAll(currentPlaylistId).onsuccess = e => res(e.target.result); });
      renderPlaylist();
    }

    function renderPlaylist() {
      if (playlist.length === 0) {
        playlistContainer.innerHTML = '<div style="text-align:center; color:#888; padding:20px;">Empty playlist</div>';
        return;
      }
      playlistContainer.innerHTML = playlist.map((s, i) => `
        <div class="song-item ${i === currentIndex ? 'active' : ''}" onclick="playSong(${i})">
          <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${s.name}</span>
          <button class="delete-btn" onclick="deleteSong(event, ${s.id})">‚úï</button>
        </div>
      `).join('');
    }

    document.getElementById('fileInput').onchange = async (e) => {
      const wasEmpty = playlist.length === 0;
      for (const file of e.target.files) {
        const buf = await file.arrayBuffer();
        await new Promise(res => { 
          getStore("songs", "readwrite").add({ name: file.name, data: buf, type: file.type, playlistId: currentPlaylistId }).onsuccess = res; 
        });
      }
      await loadSongs();
      if (wasEmpty && playlist.length > 0) playSong(0);
    };

    async function deleteSong(e, id) {
      e.stopPropagation();
      await new Promise(res => { getStore("songs", "readwrite").delete(id).onsuccess = res; });
      if (currentIndex !== -1 && playlist[currentIndex]?.id === id) {
        audio.pause();
        currentIndex = -1;
        songTitle.textContent = "No song selected";
        albumArt.style.display = "none";
      }
      loadSongs();
    }

    async function refreshPlaylists() {
      const lists = await new Promise(res => { getStore("playlists", "readonly").getAll().onsuccess = e => res(e.target.result); });
      if (lists.length === 0) {
        const id = await new Promise(res => { getStore("playlists", "readwrite").add({name: "My Music"}).onsuccess = e => res(e.target.result); });
        currentPlaylistId = id;
        return refreshPlaylists();
      }
      playlistSelect.innerHTML = lists.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
      if (!currentPlaylistId) currentPlaylistId = lists[0].id;
      playlistSelect.value = currentPlaylistId;
      await loadSongs();
    }

    playlistSelect.onchange = (e) => {
      currentPlaylistId = parseInt(e.target.value);
      loadSongs();
    };

    document.getElementById('newPlaylist').onclick = async () => {
      const name = prompt("Playlist name:");
      if (!name) return;
      currentPlaylistId = await new Promise(res => { getStore("playlists", "readwrite").add({name}).onsuccess = e => res(e.target.result); });
      await refreshPlaylists();
    };

    // Audio Logic
    audio.ontimeupdate = () => {
      if (audio.duration) {
        progressBar.style.width = (audio.currentTime / audio.duration * 100) + "%";
        currentTimeEl.textContent = formatTime(audio.currentTime);
      }
    };
    audio.onloadedmetadata = () => { durationEl.textContent = formatTime(audio.duration); };
    playPauseBtn.onclick = () => audio.paused ? audio.play() : audio.pause();
    audio.onplay = () => playPauseBtn.textContent = '‚è∏';
    audio.onpause = () => playPauseBtn.textContent = '‚ñ∂';
    document.getElementById('nextBtn').onclick = () => currentIndex < playlist.length - 1 && playSong(currentIndex + 1);
    document.getElementById('prevBtn').onclick = () => currentIndex > 0 && playSong(currentIndex - 1);
    audio.onended = () => document.getElementById('nextBtn').click();

    document.getElementById('progressContainer').onclick = (e) => {
      const rect = e.currentTarget.getBoundingClientRect();
      audio.currentTime = ((e.clientX - rect.left) / rect.width) * audio.duration;
    };

    window.onload = async () => {
      await initDB();
      await refreshPlaylists();
    };
</script>
</body>
</html>